<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="Access-Control-Allow-Origin" content="*">
	<title>盗梦空间-个人博客</title>
	<script type="text/javascript" src="../js/jquery.min.js"></script>
	<script type="text/javascript" src="../data/provinces34.json"></script>

	<style type="text/css">
		#testHtml{
			border: 1px solid red;
			width: 1200px;
			height: 500px;
		}
	</style>
	
</head>
<body>
	<div class="storeData" hidden="hidden"></div>
	
	<div id="weather"></div>

	<p class="provinces"></p>

	<script type="text/javascript">
		/**
		步骤:
			1:统计34个身份
			2.根据34个省份的名称 获取 cityid
			3.通过cityid到 “中国天气” 获取天气数据，存入json中备用
			4.地图绘制
			5.获取当前用户的地区，加载最高温度，最低温度及一天内温度折线图
			6.添加 选择城市 查询功能
		*/

		$(function(){
			//此接口可以获取cityID，及7天天气预报(可能不太准确)
			/*$.ajax({
				url:'http://api.k780.com:88/?app=weather.future&weaid=1&&appkey=10003&sign=b59bc3ef6191eb9f747dd4e83c99f2a4&format=json&jsoncallback=data',
				type:'get',
				dataType:'jsonp',
				jsonp:'jsoncallback',
				success:function(data){
					console.log(data);
					alert(data);
				},
				error:function(XMLHttpRequest, textStatus, errorThrown){
					alert(XMLHttpRequest.status);
	                alert(XMLHttpRequest.readyState);
	                alert(textStatus);
				}
			});*/

			//解决跨域问题
			$.ajaxPrefilter(function (options) {
		        if (options.crossDomain && jQuery.support.cors) {
		            var http = (window.location.protocol === 'http:' ? 'http:' : 'https:');
		            options.url = http + '//cors-anywhere.herokuapp.com/' + options.url;
		            //options.url = "http://cors.corsproxy.io/url=" + options.url;
		        }
		    });

		    //getChinaWeather("101010100","北京市");



			var data = getProvinces();
			
			for(var key in data){
				//console.log(key + " : " + data[key]);
				getChinaWeather(key,data[key]);
			}


		});
		
		//定义json格式
		var flg = true;
	    var provincesJson = {};
		function getChinaWeather(cityId,cityName){
			$.get('http://www.weather.com.cn/weather1d/'+cityId+'.shtml',function (response) {
	        	//截取需要用到的html内容
	        	var startIndex = response.indexOf('<div class="today clearfix" id="today">');
	        	var endIndex = response.indexOf('<script>',startIndex);

	        	
	        	var weatherHtml = response.substring(startIndex,endIndex+9);

	        	//截取7天内的天气预报
	        	var hourDataStartIndex = response.indexOf('{',startIndex);

	        	var hourDataEndIndex = response.indexOf('}',startIndex);

	        	var hourData = response.substring(hourDataStartIndex,hourDataEndIndex+1);

	        	//json格式字符串转换为json对象
	        	hourData = JSON.parse(hourData);

				/*for(var key in hourData){
	        		console.log(key);
	        		console.log(hourData[key]);
	        	}*/

	        	//console.log(hourData);

				//只获取当前一天内的天气预报
	        	var weatherHourData = hourData["1d"];


	        	/*for(var i in weatherHourData){
	        		console.log(weatherHourData[i]);
	        	}*/

	        	//console.log(weatherHtml);
	        	$(".storeData").html(weatherHtml);

	        	//基本情况:07月30日08时 周一  晴  34/25°C
	        	var basicMessage = $(".storeData > #today > #hidden_title").val();

	        	var weather_conditions = basicMessage.substring(basicMessage.indexOf("周")+4,basicMessage.lastIndexOf(" ")-1);

	        	//console.log(basicMessage);

	        	//获取白天天气预报
	        	var currentData = $(".storeData > #today > .t > .clearfix > li").first();

	        	var current_time = currentData.children("h1").text();

	        	var current_condition = currentData.children(".wea").text();

	        	var current_temperature = currentData.children(".tem").children("span").text()+"°C";

	        	//获取夜间天气预报
	        	var forecastData = $(".storeData > #today > .t > .clearfix > li").last();

	        	var forecast_time = forecastData.children("h1").text();

	        	var forecast_condition = forecastData.children(".wea").text();

	        	var forecast_temperature = forecastData.children(".tem").children("span").text()+"°C";


	        	//将存放数据的html清空，便于下次使用
	        	$(".storeData").empty();

	        	//将数据添加到自定义json中
	        	var cityJson = {};
	        	provincesJson[cityName] = cityJson;
	        	cityJson["weather_conditions"] = weather_conditions;
	        	cityJson["currentData"] = {"current_time":current_time,"current_temperature":current_temperature,"current_condition":current_condition};
	        	cityJson["forecastData"] = {"forecast_time":forecast_time,"forecast_temperature":forecast_temperature,"forecast_condition":forecast_condition};
	        	cityJson["weatherHourData"] = weatherHourData;
	        	
	        	//console.log(cityName + "天气预报数据已存在自定义json对象中");
	        	if(Object.keys(provincesJson).length == 34){
	        		console.log(provincesJson);
	        	}
	        });
		}

	</script>




</body>
</html>